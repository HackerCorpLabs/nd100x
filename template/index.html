<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ND100X WASM Emulator</title>
  <!-- Add xterm.js and its CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.min.css">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .terminal-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    .terminal-tab {
      padding: 8px 16px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
    }
    .terminal-tab.active {
      background-color: #000;
      color: white;
    }
    .terminal-container {
      height: 480px;
      background-color: #000;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .terminal-container.active {
      display: block;
    }
    .control-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ND100X Emulator</h1>
    <p id="status">Loading WebAssembly module...</p>

    <div id="controls" class="control-panel" style="display: none;">
      <button id="init-btn">Initialize</button>
      <button id="start-btn" disabled>Start</button>
      <button id="stop-btn" disabled>Stop</button>
      
      <div class="slider-container">
        <label for="boot-select">Boot device:</label>
        <select id="boot-select">
          <option value="smd">SMD</option>
          <option value="floppy" selected>FLOPPY</option>
        </select>
      </div>
      
      <div class="slider-container">
        <label for="floppy-select">Floppy image:</label>
        <select id="floppy-select">
          <option value="FLOPPY.IMG">FLOPPY.IMG</option>
          <option value="SMD0.IMG">SMD0.IMG</option>
        </select>
      </div>
    </div>

    <div class="terminal-tabs"></div>
    <!-- All terminal containers will be created dynamically by JS below this line -->    
  </div>

  <script src="nd100wasm.js"></script>
  <script>
    // Store all terminals and their containers
    let terminals = {};
    let terminalContainers = {};
    let activeTerminalId = 1;
    let Module = null;
    const RAW_MODE = true;
    let isInitialized = false;

    // Function to create a terminal container and tab
    function createTerminal(id, name) {
        // Create container
        const container = document.createElement('div');
        container.id = `terminal-container-${id}`;
        container.className = 'terminal-container';
        // Insert container immediately after the .terminal-tabs div
        const tabs = document.querySelector('.terminal-tabs');
        if (tabs.nextSibling) {
            tabs.parentNode.insertBefore(container, tabs.nextSibling);
        } else {
            tabs.parentNode.appendChild(container);
        }
        
        // Create tab
        const tab = document.createElement('div');
        tab.className = 'terminal-tab';
        tab.dataset.terminal = id;
        tab.textContent = name;
        document.querySelector('.terminal-tabs').appendChild(tab);
        
        // Initialize terminal
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: 'Courier New, monospace',
            rows: 24,
            cols: 80,
            theme: {
                background: '#000000',
                foreground: '#ffffff'
            }
        });
        
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(container);
        fitAddon.fit();
        
        // Store references
        terminals[id] = {
            term,
            fitAddon,
            container
        };
        terminalContainers[id] = container;
        
        // Add click handler for tab
        tab.addEventListener('click', () => {
            switchTerminal(id);
        });
        
        // Add keyboard input handler
        term.onKey(({ key, domEvent }) => {
            // Only process input for the active terminal
            if (id !== activeTerminalId) return;

            const charCode = key.charCodeAt(0);
            
            if (RAW_MODE) {
                if (domEvent.ctrlKey && charCode >= 65 && charCode <= 90) {
                    const ctrlCode = charCode - 64;
                    sendKey(ctrlCode);
                } else if (charCode === 10) {
                    sendKey(13);
                } else {
                    sendKey(charCode);
                }
                
                if (charCode === 8 || charCode === 127) {
                    term.write('\b \b');
                }
            }
        });
        
        // Write welcome message
        term.writeln(`ND100X Emulator - ${name}`);
        term.writeln('----------------------------------');
    }

    // Function to initialize all available terminals
    function initializeTerminals() {
        if (!Module || !Module._GetTerminalAddress) {
            // If the module isn't ready, show a static Console tab named '1'
            document.querySelector('.terminal-tabs').innerHTML = '';
            document.querySelectorAll('.terminal-container').forEach(el => el.remove());
            createTerminal(1, '1');
            switchTerminal(1);
            return;
        }
        // Remove all existing terminal containers from the DOM
        document.querySelectorAll('.terminal-container').forEach(el => el.remove());
        // Clear existing tabs and JS references
        document.querySelector('.terminal-tabs').innerHTML = '';
        Object.keys(terminals).forEach(id => {
            terminals[id].term.dispose();
        });
        terminals = {};
        terminalContainers = {};
        // Always create Console terminal (index 0) as '1'
        createTerminal(1, '1');
        // If initialized, add other terminals
        if (isInitialized) {
            for (let i = 1; i < 16; i++) {
                const address = Module._GetTerminalAddress(i);
                if (address !== -1) {
                    const identCode = Module._GetTerminalIdentCode(i);
                    const octalIdent = identCode !== -1 ? identCode.toString(8) : `Term ${i+1}`;
                    createTerminal(i + 1, octalIdent);
                }
            }
        }
        // Set first terminal as active if any
        const firstId = Object.keys(terminals)[0];
        if (firstId) switchTerminal(Number(firstId));
    }

    // Make terminals responsive to window resize
    window.addEventListener('resize', () => {
        Object.values(terminals).forEach(terminal => {
            terminal.fitAddon.fit();
        });
    });

    function switchTerminal(id) {
        // Update active tab
        document.querySelectorAll('.terminal-tab').forEach(tab => {
            tab.classList.toggle('active', parseInt(tab.dataset.terminal) === id);
        });

        // Update active terminal container
        Object.keys(terminalContainers).forEach(terminalId => {
            terminalContainers[terminalId].classList.toggle('active', parseInt(terminalId) === id);
        });

        activeTerminalId = id;
    }

    // Function to register terminal callbacks
    function registerTerminalCallbacks() {
        if (!Module || !Module._SetTerminalOutputCallback) {
            console.error("Module not ready for terminal callback registration");
            return false;
        }
        
        try {
            // Create a JavaScript function that will be called from C
            const outputCallback = Module.addFunction(function(terminalId, c) {
                // Write to the appropriate terminal
                if (terminals[terminalId] && terminals[terminalId].term) {
                    terminals[terminalId].term.write(String.fromCharCode(c));
                } else {
                    console.error(`Terminal ${terminalId} not found or term not initialized`);
                }
            }, 'vii'); // 'vii' means void return, int, int parameters
            
            // Register callbacks for all terminals
            Object.keys(terminals).forEach(id => {
                console.log(`Registering output callback for terminal ${id}`);
                Module._SetTerminalOutputCallback(parseInt(id), outputCallback);
                console.log(`Terminal output callback registered for terminal ${id}`);
            });
            
            return true;
        } catch (e) {
            console.error("Error registering terminal callback:", e);
            return false;
        }
    }

    // Function to send a key to the currently active terminal
    function sendKey(keyCode) {
        if (!Module || !Module._SendKeyToTerminal) {
            console.error("SendKeyToTerminal not available, module loaded:", !!Module);
            return false;
        }
        
        try {
            // Call the SendKeyToTerminal function with the active terminal ID and key code
            const result = Module._SendKeyToTerminal(activeTerminalId, keyCode);
            if (result !== 1) {
                console.error("Failed to send key to terminal", activeTerminalId);
                return false;
            }
            return true;
        } catch (e) {
            console.error("Error sending key to terminal:", e);
            return false;
        }
    }

    // Emulation state
    let emulationRunning = false;
    let loopId = null;
    const instructionsPerFrame = 10000;
    let continuousStepMode = false;

    function executeInstructionBatch() {
        if (!emulationRunning && !continuousStepMode) {
            return;
        }
        
        if (!Module || !Module._Step) {
            console.error("Step function not available");
            return;
        }
        
        try {
            Module._Step(instructionsPerFrame);
            
            if (emulationRunning || continuousStepMode) {
                loopId = requestAnimationFrame(executeInstructionBatch);
            }
        } catch (e) {
            console.error("Error executing instructions:", e);
            terminals[activeTerminalId].term.writeln(`\r\nError: ${e.message}`);
            stopEmulation();
        }
    }

    function startEmulation() {
        if (emulationRunning) return;
        
        emulationRunning = true;
        document.getElementById('status').textContent = 'Emulation running...';
        terminals[activeTerminalId].term.writeln('\r\nEmulation started');
        
        document.getElementById('start-btn').disabled = true;
        document.getElementById('stop-btn').disabled = false;
        
        loopId = requestAnimationFrame(executeInstructionBatch);
    }

    function stopEmulation() {
        if (!emulationRunning && !continuousStepMode) return;
        
        emulationRunning = false;
        continuousStepMode = false;
        
        if (loopId !== null) {
            cancelAnimationFrame(loopId);
            loopId = null;
        }
        
        document.getElementById('status').textContent = 'Emulation stopped';
        terminals[activeTerminalId].term.writeln('\r\nEmulation stopped');
        document.getElementById('start-btn').disabled = false;
        document.getElementById('stop-btn').disabled = true;
    }

    // Define configuration for Module
    const moduleConfig = {
        print: (text) => {
            console.log(text);
        },
        printErr: (text) => {
            console.error(text);
        },
        onRuntimeInitialized: function() {
            console.log("WASM Runtime Initialized");
        }
    };
    
    // Create the Module variable by calling the factory function
    console.log("Initializing ND100Module");
    ND100Module(moduleConfig).then(moduleInstance => {
        Module = moduleInstance;
        console.log("ND100Module loaded successfully");
        
        // Initialize terminals after module is loaded
        initializeTerminals();
        
        // Load SMD0.IMG
        console.log("Loading SMD0.IMG...");
        
        fetch('SMD0.IMG')
            .then(res => res.arrayBuffer())
            .then(buf => {
                try {
                    Module.FS.writeFile('/SMD0.IMG', new Uint8Array(buf));
                    console.log("SMD0.IMG loaded");
                    
                    // Load FLOPPY.IMG
                    console.log("Loading FLOPPY.IMG...");
                    
                    fetch('FLOPPY.IMG')
                        .then(res => res.arrayBuffer())
                        .then(buf => {
                            try {
                                Module.FS.writeFile('/FLOPPY.IMG', new Uint8Array(buf));
                                console.log("FLOPPY.IMG loaded");
                                
                                document.getElementById('status').textContent = 'WebAssembly module loaded!';
                                document.getElementById('controls').style.display = 'flex';
                                
                                // Connect buttons to exported WASM functions
                                document.getElementById('init-btn').addEventListener('click', function() {
                                    console.log("Calling Init");
                                    // Determine boot device
                                    const bootDevice = document.getElementById('boot-select').value;
                                    const bootSmd = (bootDevice === 'smd') ? 1 : 0;
                                    Module._Init(bootSmd);
                                    // Set flag and scan for new terminals after Init
                                    isInitialized = true;
                                    initializeTerminals();
                                    // Register callbacks after initialization
                                    if (registerTerminalCallbacks()) {
                                        console.log("Terminal callbacks registered successfully");
                                        document.getElementById('start-btn').disabled = false;
                                    } else {
                                        console.error("Failed to register terminal callbacks");
                                        document.getElementById('start-btn').disabled = true;
                                    }
                                });
                                
                                document.getElementById('start-btn').addEventListener('click', function() {
                                    console.log("Starting emulation");
                                    if (Module._Start) {
                                        Module._Start();
                                    }
                                    startEmulation();
                                });
                                
                                document.getElementById('stop-btn').addEventListener('click', function() {
                                    console.log("Stopping emulation");
                                    stopEmulation();
                                    if (Module._Stop) {
                                        Module._Stop();
                                    }
                                });
                                
                                console.log("Ready for initialization - click Initialize button to start");
                            } catch (e) {
                                console.error("Error writing FLOPPY.IMG:", e);
                            }
                        })
                        .catch(error => {
                            console.error("Failed to load FLOPPY.IMG:", error);
                            document.getElementById('status').textContent = 'Error loading disk image: ' + error.message;
                        });
                } catch (e) {
                    console.error("Error writing SMD0.IMG:", e);
                }
            })
            .catch(error => {
                console.error("Failed to load SMD0.IMG:", error);
                document.getElementById('status').textContent = 'Error loading disk image: ' + error.message;
            });
    }).catch(err => {
        console.error("Failed to initialize ND100Module:", err);
        document.getElementById('status').textContent = 'Error loading WebAssembly module: ' + err.message;
    });
  </script>
</body>
</html>
